<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPEN Line History - Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .main-pane {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background: #fff;
        }

        .history-pane {
            width: 400px;
            border-left: 2px solid #ddd;
            background: #f5f5f5;
        }

        h1 {
            margin-bottom: 1rem;
            color: #333;
        }

        .controls {
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .controls h2 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #555;
        }

        button {
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        button:hover {
            background: #1976D2;
        }

        .line-list {
            list-style: none;
        }

        .line-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .line-item:hover {
            background: #f0f7ff;
            border-color: #2196F3;
        }

        .line-item.active {
            background: #e3f2fd;
            border-color: #2196F3;
            border-left-width: 4px;
        }

        .line-text {
            font-family: monospace;
            margin-top: 0.5rem;
            color: #333;
        }

        .line-meta {
            margin-top: 0.25rem;
            color: #666;
            font-size: 0.85rem;
        }

        .line-uri {
            margin-top: 0.25rem;
        }

        .line-uri code {
            background: #f0f0f0;
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-size: 0.75rem;
            color: #666;
        }

        .info {
            padding: 1rem;
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .info h3 {
            margin-bottom: 0.5rem;
            color: #1976D2;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .history-pane {
                width: 100%;
                border-left: none;
                border-top: 2px solid #ddd;
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-pane">
            <h1>TPEN Line History Demo</h1>
            
            <div class="info">
                <h3>About this component</h3>
                <p>This component displays the history of transcription lines from TPEN projects. The demo loads real annotation data from a RERUM annotation page and shows how the history component works with actual TPEN line data. Click on a line below to see its history in the right pane.</p>
                <p><strong>Data source:</strong> <code>https://devstore.rerum.io/v1/id/68d4490c73ed8d0e76715dc3</code></p>
            </div>

            <div class="controls">
                <h2>Annotation Lines</h2>
                <p>Real annotation data from RERUM annotation page. Click on a line to view its history using RerumHistoryData:</p>
            </div>

            <ul class="line-list" id="lineList">
                <!-- Lines will be added here dynamically -->
            </ul>
        </div>

        <div class="history-pane">
            <tpen-line-history id="historyComponent" iiif-manifest="https://tpen-project-examples.habesoftware.app/Bzommar_pretty_pictures/manifest.json"></tpen-line-history>
        </div>
    </div>

    <script type="module">
        import './tpen-line-history.js'
        import TPEN from 'http://app.t-pen.org/api/TPEN.js'

        // Fetch real annotation data from the RERUM annotation page
        async function loadAnnotationData() {
            try {
                const response = await fetch('https://devstore.rerum.io/v1/id/68d4490c73ed8d0e76715dc3')
                const annotationPage = await response.json()
                
                console.log('Loaded annotation page:', annotationPage)
                
                // Extract annotation items and convert to line format
                const annotations = annotationPage.items ?? []
                const lines = []
                
                for (let i = 0; i < annotations.length; i++) {
                    const annotation = annotations[i]
                    
                    // Extract coordinates from selector value (xywh=pixel:x,y,w,h)
                    let coordinates = { x: 0, y: 0, width: 100, height: 50 }
                    if (annotation.target?.selector?.value) {
                        const match = annotation.target.selector.value.match(/xywh=pixel:(\d+),(\d+),(\d+),(\d+)/)
                        if (match) {
                            coordinates = {
                                x: parseInt(match[1]),
                                y: parseInt(match[2]),
                                width: parseInt(match[3]),
                                height: parseInt(match[4])
                            }
                        }
                    }
                    
                    // Extract text from annotation body
                    let text = ''
                    if (annotation.body) {
                        // If body is an object with value property (IIIF TextualBody)
                        if (typeof annotation.body === 'object' && annotation.body.value) {
                            text = annotation.body.value
                        }
                        // If body is an array, look for TextualBody with value
                        else if (Array.isArray(annotation.body)) {
                            for (const bodyItem of annotation.body) {
                                if (bodyItem?.value) {
                                    text = bodyItem.value
                                    break
                                }
                            }
                        }
                        // If body is a string
                        else if (typeof annotation.body === 'string') {
                            text = annotation.body
                        }
                    }
                    
                    // Fallback to placeholder if no text found
                    if (!text) {
                        text = `Line ${i + 1} (${coordinates.x}, ${coordinates.y})`
                    }
                    
                    // Create line object
                    const line = {
                        '@id': annotation.id,
                        uri: annotation.id,
                        text,
                        target: annotation.target,
                        body: annotation.body, // Preserve original body for history component
                        ...coordinates,
                        modified: annotationPage._modifiedAt ?? new Date().toISOString(),
                        created: annotationPage._createdAt ?? new Date().toISOString(),
                        // Add RERUM metadata for history tracking
                        __rerum: {
                            history: {
                                prime: 'root'
                            },
                            createdAt: annotationPage._createdAt,
                            isOverwritten: annotationPage._modifiedAt
                        }
                    }
                    
                    lines.push(line)
                }
                
                console.log('Converted lines:', lines)
                renderLines(lines)
                
            } catch (error) {
                console.error('Error loading annotation data:', error)
                // Fallback to sample data
                renderLines(getSampleLines())
            }
        }

        function getSampleLines() {
            // Fallback sample data
            return [
                {
                    '@id': 'https://example.com/line1',
                    uri: 'https://example.com/line1',
                    text: 'Sample Line 1 - Failed to load real data',
                    x: 100,
                    y: 150,
                    width: 600,
                    height: 50,
                    modified: new Date('2025-01-15T10:30:00Z').toISOString()
                },
                {
                    '@id': 'https://example.com/line2',
                    uri: 'https://example.com/line2',
                    text: 'Sample Line 2 - Failed to load real data',
                    x: 100,
                    y: 220,
                    width: 600,
                    height: 50,
                    modified: new Date('2025-01-16T14:20:00Z').toISOString()
                }
            ]
        }

        function renderLines(lines) {
            const lineList = document.getElementById('lineList')
            const historyComponent = document.getElementById('historyComponent')
            let selectedLineElement = null

            // Clear existing lines
            lineList.innerHTML = ''

            // Render lines
            lines.forEach((line, index) => {
                const li = document.createElement('li')
                li.className = 'line-item'
                li.innerHTML = `
                    <div><strong>Line ${index + 1}</strong></div>
                    <div class="line-text">${line.text ?? '(empty)'}</div>
                    <div class="line-meta">
                        <small>x: ${line.x}, y: ${line.y}, size: ${line.width}×${line.height}</small>
                    </div>
                    <div class="line-uri">
                        <small><code>${line.uri ? line.uri.split('/').pop() : 'no-uri'}</code></small>
                    </div>
                `
                
                li.addEventListener('click', async () => {
                    // Remove active class from previously selected line
                    if (selectedLineElement) {
                        selectedLineElement.classList.remove('active')
                    }
                    
                    // Add active class to clicked line
                    li.classList.add('active')
                    selectedLineElement = li

                    // Update the history component with the real line data
                    await historyComponent.handleLineChange(line)

                    // Also dispatch event to TPEN.eventDispatcher
                    TPEN.eventDispatcher.dispatchEvent(
                        new CustomEvent('tpen-set-line', { detail: line })
                    )
                })

                lineList.appendChild(li)
            })

            // Auto-select first line
            const firstLine = lineList.querySelector('.line-item')
            if (firstLine) {
                firstLine.click()
            }
        }

        // Load the annotation data when page loads
        loadAnnotationData()
    </script>
</body>
</html>
